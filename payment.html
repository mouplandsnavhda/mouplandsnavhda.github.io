<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="Missouri Uplands NAVHDA - Payment and Registration Form. Pay camping, training days, and events." />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval'; img-src 'self' https: data:;" />
  <title>Payment & Registration - MoUplands NAVHDA</title>

  <link rel="icon" href="./mouplands_cover_files/images/mouplands_logo_white.png" sizes="192x192" />
  <link href="./mouplands_cover_files/bootstrap.min.css" rel="stylesheet" />
  <link href="./mouplands_cover_files/theme.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" />
  <link href="./mouplands_cover_files/custom.css" rel="stylesheet" />

  <style>
    .payment-form { background:#f8f9fa; border-radius:10px; padding:30px; margin:20px 0; }
    .service-item { border:1px solid #dee2e6; border-radius:8px; padding:15px; margin:10px 0; background:#fff; text-align:left; }
    .quantity-input { width:90px; text-align:center; display:inline-block; }
    .total-section { background:#007bff; color:#fff; padding:20px; border-radius:8px; margin:20px 0; }
    .contact-section { background:#e9ecef; padding:20px; border-radius:8px; margin:20px 0; text-align:left; }
    .hidden { display:none; }
    #orderSummary { padding-left:18px; margin-bottom:8px; }
  </style>
</head>

<body class="text-center">

  <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark" style="opacity:.6;">
    <a class="navbar-brand" href="index.html">MoUplands</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
      aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item"><a class="nav-link" href="index.html#why">Join</a></li>
        <li class="nav-item"><a class="nav-link" href="index.html#training">Training</a></li>
        <li class="nav-item"><a class="nav-link" href="index.html#tests">Tests</a></li>
        <li class="nav-item"><a class="nav-link" href="index.html#events">Events</a></li>
        <li class="nav-item"><a class="nav-link" href="index.html#schedule">Schedule</a></li>
        <li class="nav-item"><a class="nav-link" href="index.html#officers">Officers</a></li>
        <li class="nav-item"><a class="nav-link" href="index.html#sponsors">Sponsors</a></li>
        <li class="nav-item"><a class="nav-link" href="bird-vendors.html">Bird Vendors</a></li>
        <li class="nav-item"><a class="nav-link" href="bird-orders.html">Bird Orders</a></li>
        <li class="nav-item"><a class="nav-link" href="payment.html">Payment</a></li>
      </ul>
    </div>
  </nav>

  <div class="container" style="margin-top:100px;">
    <div class="row justify-content-center">
      <div class="col-lg-8">

        <h1 class="mb-4">Payment & Registration</h1>

        <div id="testModeIndicator" class="alert alert-warning" style="display:none; text-align:left;">
          <strong>TEST MODE ACTIVE</strong> — Redirecting to PayPal Sandbox for testing.
          <small>Add <code>?test=true</code> to the URL to enable test mode.</small>
          <br />
          <small><strong>Buyer login:</strong> sb-giw2o587526@personal.example.com (use your sandbox buyer password)</small>
        </div>

        <p class="lead">Select the services you need and provide your contact information below.</p>

        <div class="payment-form">
          <form id="paymentForm">

            <!-- RV Camping -->
            <div class="service-item">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="rvCamping" />
                <label class="form-check-label" for="rvCamping">
                  <strong>RV Camping</strong> — $25/night
                </label>
              </div>
              <div class="ml-4 mt-2 hidden" id="rvCampingDetails">
                <label for="rvNights">Number of nights:</label>
                <input type="number" class="form-control quantity-input ml-2" id="rvNights" min="1" max="14" value="1" />
              </div>
            </div>

            <!-- Tent Camping -->
            <div class="service-item">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tentCamping" />
                <label class="form-check-label" for="tentCamping">
                  <strong>Tent Camping</strong> — $10/night
                </label>
              </div>
              <div class="ml-4 mt-2 hidden" id="tentCampingDetails">
                <label for="tentNights">Number of nights:</label>
                <input type="number" class="form-control quantity-input ml-2" id="tentNights" min="1" max="14" value="1" />
              </div>
            </div>

            <!-- Tests -->
            <div class="service-item">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="naTest" />
                <label class="form-check-label" for="naTest">
                  <strong>NA Test (Natural Ability) — Member</strong> — $155
                </label>
              </div>
              <small class="text-muted">For dogs 16 months and younger.</small>

              <div class="ml-4 mt-2 hidden" id="naTestDetails">
                <div class="d-flex align-items-center flex-wrap">
                  <label for="naTestQty" class="mb-0">Number of dogs:</label>
                  <input type="number" class="form-control quantity-input ml-2" id="naTestQty" min="1" max="10" value="1" />
                </div>
                <div class="mt-2">
                  <label for="naTestDogs" class="mb-0">Dog name(s) (comma-separated):</label>
                  <input type="text" class="form-control" id="naTestDogs" placeholder="e.g., Bella, Ranger" />
                </div>
              </div>
            </div>

            <div class="service-item">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="naTestNonMember" />
                <label class="form-check-label" for="naTestNonMember">
                  <strong>NA Test (Natural Ability) — Non-Member</strong> — $180
                </label>
              </div>
              <small class="text-muted">Non-member pricing.</small>

              <div class="ml-4 mt-2 hidden" id="naTestNonMemberDetails">
                <div class="d-flex align-items-center flex-wrap">
                  <label for="naTestNonMemberQty" class="mb-0">Number of dogs:</label>
                  <input type="number" class="form-control quantity-input ml-2" id="naTestNonMemberQty" min="1" max="10" value="1" />
                </div>
                <div class="mt-2">
                  <label for="naTestNonMemberDogs" class="mb-0">Dog name(s) (comma-separated):</label>
                  <input type="text" class="form-control" id="naTestNonMemberDogs" placeholder="e.g., Bella, Ranger" />
                </div>
              </div>
            </div>

            <div class="service-item">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="utGdtTest" />
                <label class="form-check-label" for="utGdtTest">
                  <strong>UT/GDT Test — Member</strong> — $190
                </label>
              </div>
              <small class="text-muted">For dogs 16 months and older.</small>

              <div class="ml-4 mt-2 hidden" id="utGdtTestDetails">
                <div class="d-flex align-items-center flex-wrap">
                  <label for="utGdtTestQty" class="mb-0">Number of dogs:</label>
                  <input type="number" class="form-control quantity-input ml-2" id="utGdtTestQty" min="1" max="10" value="1" />
                </div>
                <div class="mt-2">
                  <label for="utGdtTestDogs" class="mb-0">Dog name(s) (comma-separated):</label>
                  <input type="text" class="form-control" id="utGdtTestDogs" placeholder="e.g., Scout, River" />
                </div>
              </div>
            </div>

            <div class="service-item">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="utGdtTestNonMember" />
                <label class="form-check-label" for="utGdtTestNonMember">
                  <strong>UT/GDT Test — Non-Member</strong> — $215
                </label>
              </div>
              <small class="text-muted">Non-member pricing.</small>

              <div class="ml-4 mt-2 hidden" id="utGdtTestNonMemberDetails">
                <div class="d-flex align-items-center flex-wrap">
                  <label for="utGdtTestNonMemberQty" class="mb-0">Number of dogs:</label>
                  <input type="number" class="form-control quantity-input ml-2" id="utGdtTestNonMemberQty" min="1" max="10" value="1" />
                </div>
                <div class="mt-2">
                  <label for="utGdtTestNonMemberDogs" class="mb-0">Dog name(s) (comma-separated):</label>
                  <input type="text" class="form-control" id="utGdtTestNonMemberDogs" placeholder="e.g., Scout, River" />
                </div>
              </div>
            </div>

            <!-- Order Summary -->
            <div class="service-item" id="orderSummaryBox">
              <h4 class="mb-2">Order Summary</h4>
              <ul id="orderSummary" class="mb-2"></ul>
              <div><strong>Total:</strong> $<span id="summaryTotal">0.00</span></div>
            </div>

            <!-- Contact -->
            <div class="contact-section">
              <h4>Contact Information</h4>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="firstName">First Name *</label>
                    <input type="text" class="form-control" id="firstName" required />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="lastName">Last Name *</label>
                    <input type="text" class="form-control" id="lastName" required />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" class="form-control" id="email" required />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="phone">Phone</label>
                    <input type="tel" class="form-control" id="phone" />
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="notes">Additional Notes</label>
                <textarea class="form-control" id="notes" rows="3" placeholder="Any special requests or additional information..."></textarea>
              </div>
            </div>

            <!-- Total -->
            <div class="total-section">
              <h3>Total Amount: $<span id="totalAmount">0.00</span></h3>
              <p class="mb-0">Select your payment method below</p>
            </div>

            <!-- Buttons -->
            <div class="row justify-content-center">
              <div class="col-md-6">
                <button type="button" class="btn btn-success btn-lg btn-block mb-3" id="paypalBtn" disabled>
                  <i class="fab fa-paypal"></i> Pay with PayPal
                </button>
              </div>
              <div class="col-md-6">
                <button type="button" class="btn btn-outline-primary btn-lg btn-block mb-3" id="checkBtn">
                  <i class="fas fa-money-check-alt"></i> Pay by Check
                </button>
              </div>
            </div>

          </form>
        </div>

        <!-- Check Instructions -->
        <div class="card mt-4" id="checkInstructions" style="display:none;">
          <div class="card-header"><h4>Check Payment Instructions</h4></div>
          <div class="card-body text-left">
            <p><strong>Payable To:</strong> MO UPLANDS NAVHDA</p>
            <p><strong>Send To:</strong></p>
            <p>Jodee Mathis<br>23407 N. Hyatt Cemetery Road<br>Cuba, IL 61427</p>
            <p><strong>Amount:</strong> $<span id="checkAmount">0.00</span></p>
            <p><strong>Please include:</strong> Your name and what you're paying for in the memo line.</p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
    integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
    integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>

  <script>
    // Prices
    const PRICES = {
      rvCamping: 25,
      tentCamping: 10,
      naTest: 155,
      naTestNonMember: 180,
      utGdtTest: 190,
      utGdtTestNonMember: 215
    };

    const TESTS = [
      { id: 'naTest', label: 'NA Test (Member)', price: PRICES.naTest, details: 'naTestDetails', qty: 'naTestQty', dogs: 'naTestDogs' },
      { id: 'naTestNonMember', label: 'NA Test (Non-Member)', price: PRICES.naTestNonMember, details: 'naTestNonMemberDetails', qty: 'naTestNonMemberQty', dogs: 'naTestNonMemberDogs' },
      { id: 'utGdtTest', label: 'UT/GDT Test (Member)', price: PRICES.utGdtTest, details: 'utGdtTestDetails', qty: 'utGdtTestQty', dogs: 'utGdtTestDogs' },
      { id: 'utGdtTestNonMember', label: 'UT/GDT Test (Non-Member)', price: PRICES.utGdtTestNonMember, details: 'utGdtTestNonMemberDetails', qty: 'utGdtTestNonMemberQty', dogs: 'utGdtTestNonMemberDogs' }
    ];

    const byId = (id) => document.getElementById(id);

    function safeInt(v, fallback = 1) {
      const n = parseInt(v, 10);
      return Number.isFinite(n) && n > 0 ? n : fallback;
    }

    function getQty(id) {
      const el = byId(id);
      return safeInt(el ? el.value : "1", 1);
    }

    function cleanDogs(text) {
      return (text || "")
        .split(",")
        .map(s => s.trim())
        .filter(Boolean);
    }

    function show(id, isVisible) {
      const el = byId(id);
      if (!el) return;
      if (isVisible) el.classList.remove('hidden');
      else el.classList.add('hidden');
    }

    function setText(id, value) {
      const el = byId(id);
      if (el) el.textContent = value;
    }

    function clearTestFields(t) {
      const q = byId(t.qty);
      if (q) q.value = 1;
      const d = byId(t.dogs);
      if (d) d.value = "";
    }

    function renderTotals() {
      let total = 0;
      const lines = [];
      const services = [];
      const dogLines = [];

      // RV
      if (byId('rvCamping')?.checked) {
        const n = getQty('rvNights');
        const amt = PRICES.rvCamping * n;
        total += amt;
        lines.push(`RV Camping: ${n} night${n > 1 ? 's' : ''} = $${amt.toFixed(2)}`);
        services.push(`RV Camping (${n} night${n > 1 ? 's' : ''})`);
      }

      // Tent
      if (byId('tentCamping')?.checked) {
        const n = getQty('tentNights');
        const amt = PRICES.tentCamping * n;
        total += amt;
        lines.push(`Tent Camping: ${n} night${n > 1 ? 's' : ''} = $${amt.toFixed(2)}`);
        services.push(`Tent Camping (${n} night${n > 1 ? 's' : ''})`);
      }

      // Tests
      for (const t of TESTS) {
        const cb = byId(t.id);
        if (!cb || !cb.checked) continue;

        const q = getQty(t.qty);
        const amt = t.price * q;
        total += amt;

        lines.push(`${t.label}: x${q} = $${amt.toFixed(2)}`);
        services.push(`${t.label} x${q}`);

        const dogs = cleanDogs(byId(t.dogs)?.value || "");
        if (dogs.length) {
          dogLines.push(`${t.label} (${q}): ${dogs.join(", ")}`);
        }
      }

      // Update UI
      setText('totalAmount', total.toFixed(2));
      setText('checkAmount', total.toFixed(2));
      setText('summaryTotal', total.toFixed(2));

      const ul = byId('orderSummary');
      if (ul) ul.innerHTML = lines.length ? lines.map(l => `<li>${l}</li>`).join('') : `<li>No items selected yet.</li>`;

      const paypalBtn = byId('paypalBtn');
      if (paypalBtn) paypalBtn.disabled = total <= 0;

      return { total, services, dogLines };
    }

    function validateDogsRequired() {
      for (const t of TESTS) {
        const cb = byId(t.id);
        if (!cb || !cb.checked) continue;

        const qty = getQty(t.qty);
        const dogsEl = byId(t.dogs);
        if (!dogsEl) {
          alert(`Missing dog-name input for ${t.label} (expected id="${t.dogs}")`);
          return false;
        }

        const names = cleanDogs(dogsEl.value);
        if (names.length === 0) {
          alert(`Please enter dog name(s) for: ${t.label}`);
          dogsEl.focus();
          return false;
        }

        if (names.length !== qty) {
          alert(`For "${t.label}", you selected ${qty} dog(s) but entered ${names.length} name(s).\nEnter exactly ${qty} name(s), separated by commas.`);
          dogsEl.focus();
          return false;
        }
      }
      return true;
    }

    function enforceExclusive(aId, bId) {
      const a = TESTS.find(t => t.id === aId);
      const b = TESTS.find(t => t.id === bId);

      byId(aId)?.addEventListener('change', () => {
        if (byId(aId).checked) {
          if (byId(bId)) byId(bId).checked = false;
          show(b.details, false);
          clearTestFields(b);
        }
        show(a.details, byId(aId).checked);
        if (!byId(aId).checked) clearTestFields(a);
        renderTotals();
      });

      byId(bId)?.addEventListener('change', () => {
        if (byId(bId).checked) {
          if (byId(aId)) byId(aId).checked = false;
          show(a.details, false);
          clearTestFields(a);
        }
        show(b.details, byId(bId).checked);
        if (!byId(bId).checked) clearTestFields(b);
        renderTotals();
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const isTestMode = urlParams.get('test') === 'true';
      if (isTestMode) byId('testModeIndicator').style.display = 'block';

      // Camping toggles
      byId('rvCamping')?.addEventListener('change', () => {
        show('rvCampingDetails', byId('rvCamping').checked);
        renderTotals();
      });
      byId('tentCamping')?.addEventListener('change', () => {
        show('tentCampingDetails', byId('tentCamping').checked);
        renderTotals();
      });

      // Test toggles + exclusivity
      enforceExclusive('naTest', 'naTestNonMember');
      enforceExclusive('utGdtTest', 'utGdtTestNonMember');

      // Recalc on input changes
      [
        'rvNights','tentNights',
        'naTestQty','naTestNonMemberQty','utGdtTestQty','utGdtTestNonMemberQty',
        'naTestDogs','naTestNonMemberDogs','utGdtTestDogs','utGdtTestNonMemberDogs'
      ].forEach(id => {
        const el = byId(id);
        if (!el) return;
        el.addEventListener('input', renderTotals);
        el.addEventListener('change', renderTotals);
      });

      // PayPal button
      byId('paypalBtn')?.addEventListener('click', () => {
        if (!byId('firstName').value || !byId('lastName').value || !byId('email').value) {
          alert('Please fill in all required contact information.');
          return;
        }
        if (!validateDogsRequired()) return;

        const firstName = byId('firstName').value;
        const lastName = byId('lastName').value;
        const email = byId('email').value;
        const phone = byId('phone').value;
        const notes = byId('notes').value;

        const order = renderTotals();

        let itemName = "MO Uplands Payment";
        if (order.services.length) itemName += " - " + order.services.join(", ");

        const dogNamesSummary = order.dogLines.join(" | ");
        const servicesSummary = order.services.join(", ");

        let paypalURL;
        if (isTestMode) {
          paypalURL = new URL("https://www.sandbox.paypal.com/cgi-bin/webscr");
          paypalURL.searchParams.set("business", "sb-6pla43588420@business.example.com");
        } else {
          paypalURL = new URL("https://www.paypal.com/cgi-bin/webscr");
          paypalURL.searchParams.set("business", "paypal@mouplands.org");
        }

        paypalURL.searchParams.set("cmd", "_xclick");
        paypalURL.searchParams.set("item_name", itemName);
        paypalURL.searchParams.set("amount", order.total.toFixed(2));
        paypalURL.searchParams.set("currency_code", "USD");

        // Option fields (PayPal _xclick reliably keeps on0/on1)
        paypalURL.searchParams.set("on0", "Contact Info");
        paypalURL.searchParams.set("os0", `${firstName} ${lastName} - ${email} - ${phone || 'No phone'}`);

        paypalURL.searchParams.set("on1", "Dog Names");
        paypalURL.searchParams.set("os1", dogNamesSummary || "N/A");

        // Extra packed into custom (may truncate if very long)
        const customParts = [`Order: ${servicesSummary || 'N/A'}`, `Dogs: ${dogNamesSummary || 'N/A'}`];
        if (notes) customParts.push(`Notes: ${notes.substring(0, 180)}`);
        paypalURL.searchParams.set("custom", customParts.join(" | "));

        // Return URLs
        paypalURL.searchParams.set("return", isTestMode
          ? "https://www.mouplands.org/payment-success.html?test=true"
          : "https://www.mouplands.org/payment-success.html"
        );

        paypalURL.searchParams.set("cancel_return", isTestMode
          ? "https://www.mouplands.org/payment.html?test=true"
          : "https://www.mouplands.org/payment.html"
        );

        window.open(paypalURL.toString(), "_blank");
      });

      // Check button
      byId('checkBtn')?.addEventListener('click', () => {
        byId('checkInstructions').style.display = 'block';
        byId('checkInstructions').scrollIntoView({ behavior: 'smooth' });
      });

      // Initial state
      show('rvCampingDetails', false);
      show('tentCampingDetails', false);
      TESTS.forEach(t => show(t.details, false));
      renderTotals();
    });
  </script>
</body>
</html>
